// ======================================================
// CONFIG GÉNÉRALE
// ======================================================

// URL de base de l'API OpenRouteService (via ton Worker Cloudflare / proxy)
const ORS_PROXY_URL = "https://lagspirit-ors.jimmy-cattiau.workers.dev";

// Distance max en km pour les zones purement "distance"
const MAX_DISTANCE_KM = 150;

// Temps max de route (en minutes) au-delà duquel on considère
// qu'un chapitre ne peut probablement pas se déplacer physiquement
const MAX_TRAVEL_MINUTES = 120;

// Tableau des chapitres (chargé depuis chapters.json)
let CHAPTERS = [];

// URL du fichier chapters.json (WordPress OU mode statique)
const CHAPTERS_JSON_URL =
  (typeof lagspiritCarteData !== "undefined" &&
   typeof lagspiritCarteData.chaptersUrl === "string")
    ? lagspiritCarteData.chaptersUrl
    : "chapters.json";

// Palette de couleurs pour les chapitres
const COLORS = [
  "#e6194b","#3cb44b","#ffe119","#4363d8","#f58231",
  "#911eb4","#46f0f0","#f032e6","#bcf60c","#fabebe",
  "#008080","#e6beff","#9a6324","#fffac8","#800000",
  "#aaffc3","#808000","#ffd8b1","#000075","#808080",
  "#ffffff","#000000","#ff7f50","#6495ed","#ff69b4",
  "#cd5c5c","#ffa500","#40e0d0","#6a5acd","#7fffd4",
  "#deb887","#5f9ea0","#d2691e","#ffb6c1","#20b2aa",
  "#87cefa","#778899","#b0c4de","#00fa9a","#9370db",
  "#3cb371","#7b68ee","#48d1cc","#c71585","#191970",
  "#f4a460","#2e8b57","#fff0f5","#708090","#9acd32"
];

// Limite de distance "géométrique" pour surligner les départements
// quand coverageMode = "distance"
const MAX_DEPT_DISTANCE_KM = 150;

// GeoJSON des départements français
const DEPARTMENTS_GEOJSON_URL =
  "https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements-version-simplifiee.geojson";

// ======================================================
// INITIALISATION DE LA CARTE LEAFLET
// ======================================================

const map = L.map("map").setView([46.8, 2.5], 6);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18,
  attribution: "© OpenStreetMap contributors"
}).addTo(map);

// Marqueurs des chapitres
let chapterMarkers = [];
// Couches des départements
let departmentLayers = [];
// Index du chapitre actuellement sélectionné
let selectedChapterIndex = null;

// Marqueur de "ville recherchée" (point noir)
let searchMarker = null;
// Marqueur de localisation (point bleu)
let locateMarker = null;

// ======================================================
// GÉOCODAGE (Nominatim)
// ======================================================

function geocodeCity(city) {
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
    city + ", France"
  )}`;
  return fetch(url, { headers: { "Accept-Language": "fr" } })
    .then((res) => res.json())
    .then((results) => {
      if (results && results.length > 0) {
        return {
          lat: parseFloat(results[0].lat),
          lon: parseFloat(results[0].lon),
        };
      }
      return null;
    })
    .catch(() => null);
}

// ======================================================
// DISTANCE GÉOMÉTRIQUE (Haversine)
// ======================================================

function haversineDistance(lat1, lon1, lat2, lon2) {
  function toRad(v) {
    return (v * Math.PI) / 180;
  }
  const R = 6371; // rayon de la Terre en km
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(lat1)) *
      Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2) *
      Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// ======================================================
// CALCUL DE TEMPS DE TRAJET (OpenRouteService via proxy)
// ======================================================

async function getTravelTimeMinutes(fromLat, fromLon, toLat, toLon) {
  try {
    const body = {
      coordinates: [
        [fromLon, fromLat],
        [toLon, toLat],
      ],
    };

    const res = await fetch(ORS_PROXY_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(body),
    });

    if (!res.ok) {
      console.warn("ORS proxy HTTP error:", res.status, res.statusText);
      return null;
    }

    const data = await res.json();

    const seconds =
      data &&
      data.routes &&
      data.routes[0] &&
      typeof data.routes[0].summary.duration === "number"
        ? data.routes[0].summary.duration
        : null;

    if (!seconds) return null;

    return seconds / 60;
  } catch (err) {
    console.warn("Erreur ORS proxy:", err);
    return null;
  }
}

// ======================================================
// CHARGEMENT DES CHAPITRES
// ======================================================

async function initChapters() {
  let i = 0;
  for (const chapter of CHAPTERS) {
    if (chapter.lat == null || chapter.lon == null) {
      const coords = await geocodeCity(chapter.city);
      if (coords) {
        chapter.lat = coords.lat;
        chapter.lon = coords.lon;
      } else {
        console.warn("Impossible de géocoder la ville:", chapter.city);
        continue;
      }
    }

    const color = COLORS[i % COLORS.length];

    const marker = L.circleMarker([chapter.lat, chapter.lon], {
      radius: 7,
      color: "#000000",
      weight: 2,
      fillColor: color,
      fillOpacity: 1,
    }).addTo(map);

    marker.bindPopup(`<b>${chapter.name}</b><br>${chapter.city}`);

    chapterMarkers.push(marker);
    i++;

    await new Promise((r) => setTimeout(r, 200));
  }
}

// ======================================================
// AFFICHAGE / STYLE DES DÉPARTEMENTS
// ======================================================

function refreshDepartmentStyles() {
  departmentLayers.forEach(({ layer, chapterIndex, color, distance }) => {
    if (chapterIndex === -1 || distance > MAX_DEPT_DISTANCE_KM) {
      layer.setStyle({
        color: "#555555",
        weight: 1,
        fillColor: "#202020",
        fillOpacity: 0.15,
      });
      return;
    }

    if (selectedChapterIndex === null) {
      layer.setStyle({
        color: color,
        weight: 1.5,
        fillColor: color,
        fillOpacity: 0.25,
      });
    } else if (chapterIndex === selectedChapterIndex) {
      layer.setStyle({
        color: color,
        weight: 3,
        fillColor: color,
        fillOpacity: 0.45,
      });
    } else {
      layer.setStyle({
        color: color,
        weight: 1,
        fillColor: color,
        fillOpacity: 0.12,
      });
    }
  });
}

// ======================================================
// CHARGEMENT DES DÉPARTEMENTS
// ======================================================

async function loadDepartments() {
  const res = await fetch(DEPARTMENTS_GEOJSON_URL);
  const geojson = await res.json();

  departmentLayers = [];

  L.geoJSON(geojson, {
    style: function () {
      return {
        color: "#d4af37",
        weight: 1.5,
        fillColor: "#ffffff",
        fillOpacity: 0.25,
      };
    },
    onEachFeature: function (feature, layer) {
      const center = layer.getBounds().getCenter();

      let bestChapter = null;
      let bestDistance = Infinity;
      let bestIndex = -1;

      CHAPTERS.forEach((ch, idx) => {
        if (typeof ch.lat !== "number" || typeof ch.lon !== "number") return;
        const d = haversineDistance(center.lat, center.lng, ch.lat, ch.lon);
        if (d < bestDistance) {
          bestDistance = d;
          bestChapter = ch;
          bestIndex = idx;
        }
      });

      const deptName =
        feature.properties &&
        (feature.properties.nom || feature.properties.NOM || "Département");

      if (bestChapter && bestIndex >= 0 && bestDistance <= MAX_DEPT_DISTANCE_KM) {
        const color = COLORS[bestIndex % COLORS.length];

        departmentLayers.push({
          layer,
          chapterIndex: bestIndex,
          color,
          distance: bestDistance,
        });

        let popupContent =
          `<b>${deptName}</b><br>` +
          `Chapitre : ${bestChapter.name}<br>` +
          `Ville du chapitre : ${bestChapter.city}<br>` +
          `<small>Vous pouvez prendre contact avec ce chapitre afin d’obtenir des informations ou des conseils.</small>`;

        layer.bindPopup(popupContent);

        layer.on("click", function () {
          selectedChapterIndex = bestIndex;
          refreshDepartmentStyles();
          updateResultCard(bestChapter, deptName, false, bestDistance, null);
        });
      } else {
        const color = "#555555";
        departmentLayers.push({
          layer,
          chapterIndex: -1,
          color,
          distance: Infinity,
        });

        layer.setStyle({
          color: color,
          weight: 1,
          fillColor: "#202020",
          fillOpacity: 0.15,
        });

        layer.bindPopup(
          `<b>${deptName}</b><br>` +
            `Aucun chapitre Lag Spirit à proximité.<br>` +
            `<small>Vous pouvez utiliser la recherche en haut de la page pour connaître le chapitre Lag Spirit le plus proche ou utiliser les numéros d’urgence si nécessaire.</small>`
        );
      }
    },
  }).addTo(map);

  refreshDepartmentStyles();
}

// ======================================================
// CARTE : MISE À JOUR DU PANNEAU LATÉRAL
// ======================================================

function updateResultCard(
  chapter,
  searchedCity,
  notFound,
  distanceKm,
  travelMinutes
) {
  const card = document.getElementById("result-card");

  if (!card) return;

  if (!chapter || notFound) {
    card.innerHTML = `
      <div class="chapter-tag">Chapitre sélectionné</div>
      <h3>Aucun chapitre à proximité</h3>
      <p>
        Aucun chapitre Lag Spirit n’a été identifié à proximité de
        <strong>${searchedCity}</strong>.
      </p>
      <p>
        Vous pouvez utiliser la recherche en haut de la page pour connaître
        le chapitre Lag Spirit le plus proche et obtenir des informations
        ou des conseils.
      </p>
      <div class="help-highlight">
        <strong>Numéros d’urgence :</strong><br>
        17 – Police / Gendarmerie<br>
        15 – SAMU (urgence médicale)<br>
        18 – Pompiers<br>
        112 – Numéro d’urgence européen<br>
        119 – Enfance en danger<br>
        3018 – Cyberharcèlement et violences numériques<br>
      </div>
    `;
    return;
  }

  const phone = chapter.contactPhone
    ? `<p><strong>Téléphone :</strong> ${chapter.contactPhone}</p>`
    : "";

  const emailLink = chapter.contactEmail
    ? `<p><strong>Email :</strong> <a href="mailto:${chapter.contactEmail}" target="_blank">${chapter.contactEmail}</a></p>`
    : "";

  const facebookLink = chapter.facebook
    ? `<p><strong>Facebook :</strong> <a href="${chapter.facebook}" target="_blank">Ouvrir la page</a></p>`
    : "";

  const instagramLink = chapter.instagram
    ? `<p><strong>Instagram :</strong> <a href="${chapter.instagram}" target="_blank">Ouvrir le profil</a></p>`
    : "";

  let distanceInfo = "";
  if (typeof distanceKm === "number") {
    distanceInfo += `<p><strong>Distance estimée :</strong> ~${distanceKm.toFixed(
      0
    )} km</p>`;
  }

  let travelInfo = "";
  if (typeof travelMinutes === "number") {
    const h = Math.floor(travelMinutes / 60);
    const m = Math.round(travelMinutes % 60);
    let label = h > 0 ? `${h} h ${m} min` : `${m} min`;

    travelInfo += `<p><strong>Temps de trajet estimé :</strong> ~${label}</p>`;

    if (travelMinutes > MAX_TRAVEL_MINUTES) {
      travelInfo += `
        <p>
          La distance et le temps de trajet sont importants. 
          Il sera probablement difficile pour ce chapitre de se déplacer, 
          mais il reste disponible pour te soutenir, t’écouter
          et t’apporter des conseils à distance.
        </p>
      `;
    }
  }

  const helpInfo = chapter.helpInfo
    ? `<div class="help-highlight">${chapter.helpInfo}</div>`
    : "";

  card.innerHTML = `
    <div class="chapter-tag">Chapitre sélectionné</div>
    <h3>${chapter.name}</h3>

    <p><strong>Ville du chapitre :</strong> ${chapter.city}</p>
    <p><strong>Ville / zone recherchée :</strong> ${searchedCity}</p>
    ${distanceInfo}
    ${travelInfo}

    ${phone}
    ${emailLink}
    ${facebookLink}
    ${instagramLink}

    ${helpInfo}
  `;
}

// ======================================================
// LISTE DES CHAPITRES DANS LA SIDEBAR
// ======================================================

function renderChaptersList() {
  const container = document.getElementById("chapters-list");
  if (!container) return;
  container.innerHTML = "";

  CHAPTERS.forEach((ch, idx) => {
    const color = COLORS[idx % COLORS.length];
    const btn = document.createElement("button");
    btn.className = "chapter-list-item";
    btn.dataset.idx = idx;

    btn.innerHTML = `
      <div class="chapter-list-main">
        <span class="chapter-dot" style="background:${color}"></span>
        <span class="chapter-name">${ch.name}</span>
      </div>
    `;

    btn.addEventListener("click", () => {
      selectedChapterIndex = idx;
      refreshDepartmentStyles();

      if (typeof ch.lat === "number" && typeof ch.lon === "number") {
        map.setView([ch.lat, ch.lon], 7);
      }
      updateResultCard(ch, ch.city, false, null, null);
    });

    container.appendChild(btn);
  });
}

// ======================================================
// RECHERCHE PAR VILLE (SANS AUTO-COMPLÉTION)
// ======================================================

async function searchCity() {
  const input = document.getElementById("city-search");
  if (!input) return;
  const query = input.value.trim();
  if (!query) return;

  const coords = await geocodeCity(query);
  if (!coords) {
    updateResultCard(null, query, true);
    return;
  }

  if (searchMarker) {
    map.removeLayer(searchMarker);
    searchMarker = null;
  }

  searchMarker = L.circleMarker([coords.lat, coords.lon], {
    radius: 7,
    color: "#d4af37",
    weight: 2,
    fillColor: "#000000",
    fillOpacity: 1,
  }).addTo(map);

  let bestChapter = null;
  let bestDistance = Infinity;
  let bestIndex = -1;

  CHAPTERS.forEach((chapter, idx) => {
    if (typeof chapter.lat !== "number" || typeof chapter.lon !== "number")
      return;
    const d = haversineDistance(coords.lat, coords.lon, chapter.lat, chapter.lon);
    if (d < bestDistance) {
      bestDistance = d;
      bestChapter = chapter;
      bestIndex = idx;
    }
  });

  map.setView([coords.lat, coords.lon], 7);

  if (!bestChapter) {
    updateResultCard(null, query, true);
    return;
  }

  let travelMinutes = null;
  try {
    travelMinutes = await getTravelTimeMinutes(
      coords.lat,
      coords.lon,
      bestChapter.lat,
      bestChapter.lon
    );
  } catch (e) {
    console.warn("Erreur calcul temps de trajet:", e);
  }

  selectedChapterIndex = bestIndex;
  refreshDepartmentStyles();
  updateResultCard(bestChapter, query, false, bestDistance, travelMinutes);
}

// ======================================================
// LOCALISATION "ME LOCALISER"
// ======================================================

function locateMe() {
  if (!navigator.geolocation) {
    alert(
      "La géolocalisation n’est pas disponible sur cet appareil ou ce navigateur."
    );
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async (pos) => {
      const { latitude, longitude } = pos.coords;

      if (locateMarker) {
        map.removeLayer(locateMarker);
        locateMarker = null;
      }

      locateMarker = L.circleMarker([latitude, longitude], {
        radius: 7,
        color: "#0000ff",
        weight: 2,
        fillColor: "#000088",
        fillOpacity: 1,
      }).addTo(map);

      map.setView([latitude, longitude], 8);

      let bestChapter = null;
      let bestDistance = Infinity;
      let bestIndex = -1;

      CHAPTERS.forEach((chapter, idx) => {
        if (typeof chapter.lat !== "number" || typeof chapter.lon !== "number")
          return;
        const d = haversineDistance(
          latitude,
          longitude,
          chapter.lat,
          chapter.lon
        );
        if (d < bestDistance) {
          bestDistance = d;
          bestChapter = chapter;
          bestIndex = idx;
        }
      });

      if (!bestChapter) {
        updateResultCard(null, "ta position actuelle", true);
        return;
      }

      let travelMinutes = null;
      try {
        travelMinutes = await getTravelTimeMinutes(
          latitude,
          longitude,
          bestChapter.lat,
          bestChapter.lon
        );
      } catch (e) {
        console.warn("Erreur temps de trajet (localisation):", e);
      }

      selectedChapterIndex = bestIndex;
      refreshDepartmentStyles();
      updateResultCard(
        bestChapter,
        "ta position actuelle",
        false,
        bestDistance,
        travelMinutes
      );
    },
    (err) => {
      console.warn("Erreur de géolocalisation:", err);
      alert(
        "Impossible de récupérer ta position. Vérifie les autorisations de localisation."
      );
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0,
    }
  );
}

// ======================================================
// TOGGLE LISTE DES CHAPITRES
// ======================================================

function setupChaptersToggle() {
  const toggleBtn = document.getElementById("toggle-chapters");
  const list = document.getElementById("chapters-list");
  if (!toggleBtn || !list) return;

  function updateLabel() {
    const isCollapsed = list.classList.contains("collapsed");
    toggleBtn.textContent = isCollapsed ? "Afficher" : "Masquer";
    toggleBtn.setAttribute("aria-expanded", String(!isCollapsed));
  }

  updateLabel();

  toggleBtn.addEventListener("click", () => {
    list.classList.toggle("collapsed");
    updateLabel();
  });
}

// ======================================================
// BOUTONS / ÉVÉNEMENTS GLOBAUX
// ======================================================

function setupGlobalEvents() {
  const searchBtn = document.getElementById("search-btn");
  const locateBtn = document.getElementById("locate-btn");
  const input = document.getElementById("city-search");

  if (searchBtn) {
    searchBtn.addEventListener("click", searchCity);
  }

  if (locateBtn) {
    locateBtn.addEventListener("click", locateMe);
  }

  if (input) {
    input.addEventListener("keyup", (e) => {
      if (e.key === "Enter") searchCity();
    });
  }

  const emergencyBtn = document.getElementById("emergency-toggle");
  const emergencyBox = document.getElementById("emergency-numbers");
  if (emergencyBtn && emergencyBox) {
    emergencyBtn.addEventListener("click", () => {
      const isVisible = emergencyBox.style.display === "block";
      emergencyBox.style.display = isVisible ? "none" : "block";
      emergencyBtn.textContent = isVisible
        ? "Afficher les numéros d’urgence"
        : "Masquer les numéros d’urgence";
    });
  }
}

// ======================================================
// CHARGEMENT GLOBAL
// ======================================================

async function loadChapters() {
  try {
    const res = await fetch(CHAPTERS_JSON_URL);
    let data = await res.json();

    // Valeurs par défaut pour les nouveaux champs
    CHAPTERS = data.map((ch) => {
      const mode = ch.coverageMode || "distance";
      const maxD =
        typeof ch.maxDistanceKm === "number"
          ? ch.maxDistanceKm
          : MAX_DISTANCE_KM;
      const depts = Array.isArray(ch.departments) ? ch.departments : [];
      return {
        ...ch,
        coverageMode: mode,
        maxDistanceKm: maxD,
        departments: depts,
      };
    });
  } catch (e) {
    console.error("Erreur de chargement de chapters.json", e);
    alert("Impossible de charger la liste des chapitres (chapters.json).");
    return;
  }
}

async function main() {
  await loadChapters();
  await initChapters();
  renderChaptersList();
  setupChaptersToggle();
  await loadDepartments();
  setupGlobalEvents();
}

document.addEventListener("DOMContentLoaded", main);