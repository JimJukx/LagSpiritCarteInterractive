/**
 * LAG EVENTS - Page événements 4 zones (fiche + calendrier / listes)
 * Shortcode: [lag_events_page]
 *
 * NOTE IMPORTANT:
 * - Le chapitre "référent" (pour Club House -> réseaux Facebook/Instagram) est lu depuis le CPT "general".
 * - Renseigne le nom exact du champ ACF contenant l'ID du chapitre référent ci-dessous :
 *   'general_ref_chapitre_id' => 'TON_CHAMP_ACF_ICI'
 */

if (!defined('ABSPATH')) exit;

function lag_events_config() {
  return [
    'post_type' => 'evenement',

    // --- MAPPING CHAMPS ACF (EVENEMENT) ---
    'acf' => [
      'type'             => 'evenement_type',
      'datetime'         => 'evenement_date_heure',
      'lieu'             => 'evenement_lieu',
      'maps_url'         => 'evenement_lien_google_maps',
      'affiche'          => 'evenement_affiche',
      'description'      => 'evenement_description',
      'inscription'      => 'evenement_inscription',          // none | free | paid
      'lien_inscription' => 'evenement_lien_inscription',
      'prix_inscription' => 'evenement_prix_inscription',
      'lien_annexe'      => 'evenement_lien_annexe',

      // inter-chapitre (nom + ID du chapitre visité)
      'chapitre_nom'     => 'evenement_chapitre_visite_nom',
      'chapitre_id'      => 'evenement_chapitre_visite_id',
    ],

    // --- CPT GENERAL : champ ACF qui contient l'ID du chapitre référent (pour Club House) ---
    // ⛔️ A MODIFIER si ton champ n’a pas ce nom
    'general_ref_chapitre_id' => 'general_chapitre_reference_id',

    // --- ACF CHAPITRES (réseaux) ---
    'chapitre_acf' => [
      'site'      => 'chapitre_site',
      'linktree'  => 'chapitre_linktree',
      'facebook'  => 'chapitre_facebook',
      'instagram' => 'chapitre_instagram',
      'youtube'   => 'chapitre_youtube',
      'tiktok'    => 'chapitre_tiktok',
    ],

    // --- ICONES (ACF dans CPT "general" qui renvoient une URL ou ID/array image) ---
    'icons_acf' => [
      'post_type' => 'general',
      'site'      => 'general_icone_site',
      'linktree'  => 'general_icone_linktree',
      'facebook'  => 'general_icone_facebook',
      'instagram' => 'general_icone_instagram',
      'youtube'   => 'general_icone_youtube',
      'tiktok'    => 'general_icone_tiktok',
    ],

    // --- UI ---
    'ui' => [
      'bg'          => '#0f0f10',
      'panel'       => '#17181a',
      'panel_2'     => '#1d1f22',
      'border'      => 'rgba(255,255,255,.08)',
      'text'        => 'rgba(255,255,255,.92)',
      'muted'       => 'rgba(255,255,255,.72)',
      'muted2'      => 'rgba(255,255,255,.58)',
      'shadow'      => 'rgba(0,0,0,.55)',

      // OR biker
      'gold'        => '#9a7424',
      'goldbg'      => 'rgba(154,116,36,.18)',
      'goldbg2'     => 'rgba(154,116,36,.28)',
      'goldbd'      => 'rgba(154,116,36,.40)',

      // sélection
      'sel'         => 'rgba(154,116,36,.55)',

      // police (Elementor)
      'font_viking' => 'Viking',
    ],

    'limits' => [
      'upcoming' => 50,
      'past'     => 50,
    ],
  ];
}

function lag_events_parse_datetime($raw) : ?DateTime {
  if (!$raw) return null;
  $ts = strtotime($raw);
  if ($ts) {
    $dt = new DateTime('@'.$ts);
    $dt->setTimezone(wp_timezone());
    return $dt;
  }
  foreach (['Y-m-d H:i:s','Y-m-d H:i','d/m/Y H:i','d/m/Y G:i','d/m/Y g:i a','m/d/Y g:i a'] as $fmt) {
    $dt = DateTime::createFromFormat($fmt, $raw, wp_timezone());
    if ($dt instanceof DateTime) return $dt;
  }
  return null;
}

/**
 * GENERAL: get single General post ID
 */
function lag_events_get_general_id(): ?int {
  $cfg = lag_events_config();
  $pt = $cfg['icons_acf']['post_type'] ?? 'general';

  $ids = get_posts([
    'post_type'      => $pt,
    'post_status'    => ['publish','draft','pending','private'],
    'posts_per_page' => 1,
    'orderby'        => 'date',
    'order'          => 'ASC',
    'fields'         => 'ids',
  ]);
  return !empty($ids) ? (int)$ids[0] : null;
}

/**
 * Get icon URL from General (supports URL / image ID / image array)
 */
function lag_events_get_icon_url(string $key): string {
  $cfg = lag_events_config();
  $general_id = lag_events_get_general_id();
  if (!$general_id) return '';

  $field = $cfg['icons_acf'][$key] ?? '';
  if (!$field) return '';

  $val = get_field($field, $general_id);
  if (!$val) return '';

  if (is_numeric($val)) {
    $url = wp_get_attachment_url((int)$val);
    return $url ? esc_url($url) : '';
  }
  if (is_array($val) && !empty($val['url'])) return esc_url($val['url']);
  if (is_string($val) && filter_var($val, FILTER_VALIDATE_URL)) return esc_url($val);

  return '';
}

/**
 * Get chapitre socials (only filled URLs)
 */
function lag_events_get_chapitre_socials(int $chapitre_id): array {
  $cfg = lag_events_config();
  $map = $cfg['chapitre_acf'] ?? [];
  $out = [];

  foreach ($map as $key => $acf_field) {
    $v = trim((string) get_field($acf_field, $chapitre_id));
    if ($v && filter_var($v, FILTER_VALIDATE_URL)) {
      $out[$key] = esc_url($v);
    }
  }
  return $out;
}

/**
 * Read referent chapitre ID from CPT "general"
 */
function lag_events_get_referent_chapitre_id(): int {
  $cfg = lag_events_config();
  $general_id = lag_events_get_general_id();
  if (!$general_id) return 0;

  $field = $cfg['general_ref_chapitre_id'] ?? '';
  if (!$field) return 0;

  $v = get_field($field, $general_id);

  // support numeric / array / object
  if (is_numeric($v)) return (int)$v;
  if (is_array($v) && isset($v['ID'])) return (int)$v['ID'];
  if (is_object($v) && isset($v->ID)) return (int)$v->ID;

  return 0;
}

function lag_events_get_event_data($post_id) : array {
  $cfg = lag_events_config();
  $acf = $cfg['acf'];
  $ui  = $cfg['ui'];

  $type = (string) get_field($acf['type'], $post_id);
  $dt   = lag_events_parse_datetime(get_field($acf['datetime'], $post_id));

  $affiche_id = (int) get_field($acf['affiche'], $post_id);

  $prix = get_field($acf['prix_inscription'], $post_id);
  $prix = is_numeric($prix) ? (float)$prix : null;

  return [
    'id' => (int)$post_id,
    'title' => get_the_title($post_id),

    // type conservé pour logique (club_house / inter-chapitre), mais PLUS affiché visuellement
    'type' => $type,

    'date_iso'   => $dt ? $dt->format('Y-m-d') : '',
    'date_human' => $dt ? date_i18n('D j M Y \à H\hi', $dt->getTimestamp()) : '',
    'timestamp'  => $dt ? $dt->getTimestamp() : 0,

    'lieu' => (string) get_field($acf['lieu'], $post_id),
    'maps' => (string) get_field($acf['maps_url'], $post_id),

    'affiche_url' => $affiche_id ? wp_get_attachment_image_url($affiche_id, 'large') : '',
    'description' => (string) get_field($acf['description'], $post_id),

    'inscription'      => (string) get_field($acf['inscription'], $post_id),
    'lien_inscription' => (string) get_field($acf['lien_inscription'], $post_id),
    'prix_inscription' => $prix,

    'lien_annexe' => (string) get_field($acf['lien_annexe'], $post_id),

    'chapitre_nom' => (string) get_field($acf['chapitre_nom'], $post_id),
    'chapitre_id'  => (int) get_field($acf['chapitre_id'], $post_id),

    // couleur unique (or)
    'ui_color' => (string)($ui['gold'] ?? '#9a7424'),
  ];
}

function lag_events_get_next_event_id() : int {
  $cfg = lag_events_config();
  $acf_dt = $cfg['acf']['datetime'];
  $now = current_time('timestamp');

  $q = new WP_Query([
    'post_type' => $cfg['post_type'],
    'post_status' => 'publish',
    'posts_per_page' => 1,
    'meta_key' => $acf_dt,
    'orderby' => 'meta_value',
    'order' => 'ASC',
    'meta_query' => [[
      'key' => $acf_dt,
      'value' => date('Y-m-d H:i:s', $now),
      'compare' => '>=',
      'type' => 'DATETIME',
    ]],
  ]);
  if ($q->have_posts()) return (int)$q->posts[0]->ID;

  $q2 = new WP_Query([
    'post_type' => $cfg['post_type'],
    'post_status' => 'publish',
    'posts_per_page' => 1,
    'meta_key' => $acf_dt,
    'orderby' => 'meta_value',
    'order' => 'DESC',
  ]);
  return $q2->have_posts() ? (int)$q2->posts[0]->ID : 0;
}

function lag_events_get_list($mode = 'upcoming') : array {
  $cfg = lag_events_config();
  $acf_dt = $cfg['acf']['datetime'];
  $now = current_time('timestamp');
  $is_upcoming = ($mode === 'upcoming');

  $q = new WP_Query([
    'post_type' => $cfg['post_type'],
    'post_status' => 'publish',
    'posts_per_page' => $cfg['limits'][$mode] ?? 50,
    'meta_key' => $acf_dt,
    'orderby' => 'meta_value',
    'order' => $is_upcoming ? 'ASC' : 'DESC',
    'meta_query' => [[
      'key' => $acf_dt,
      'value' => date('Y-m-d H:i:s', $now),
      'compare' => $is_upcoming ? '>=' : '<',
      'type' => 'DATETIME',
    ]],
  ]);

  return array_map(fn($p) => lag_events_get_event_data($p->ID), $q->posts);
}

function lag_events_get_month_map(int $year, int $month) : array {
  $cfg = lag_events_config();
  $acf_dt = $cfg['acf']['datetime'];

  $start = new DateTime("$year-$month-01 00:00:00", wp_timezone());
  $end = clone $start; $end->modify('first day of next month');

  $q = new WP_Query([
    'post_type' => $cfg['post_type'],
    'post_status' => 'publish',
    'posts_per_page' => -1,
    'meta_key' => $acf_dt,
    'orderby' => 'meta_value',
    'order' => 'ASC',
    'meta_query' => [[
      'key' => $acf_dt,
      'value' => [$start->format('Y-m-d H:i:s'), $end->format('Y-m-d H:i:s')],
      'compare' => 'BETWEEN',
      'type' => 'DATETIME',
    ]],
  ]);

  $by_day = [];
  foreach ($q->posts as $p) {
    $ev = lag_events_get_event_data($p->ID);
    if (!$ev['date_iso']) continue;
    $by_day[$ev['date_iso']][] = $ev;
  }

  // "best" = premier de la journée (peu importe type, car non utilisé visuellement)
  $best_by_day = [];
  foreach ($by_day as $day => $events) {
    $best_by_day[$day] = $events[0];
  }

  return [
    'events_by_day' => $by_day,
    'best_by_day'   => $best_by_day,
  ];
}

function lag_events_svg_map_pin() : string {
  return '<svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
    <path fill="currentColor" d="M12 2c-3.86 0-7 3.14-7 7c0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7zm0 9.5A2.5 2.5 0 1 1 12 6a2.5 2.5 0 0 1 0 5.5z"/>
  </svg>';
}

/**
 * Detail card (fiche)
 * - Type non affiché
 * - Club House: bouton "Nous contacter" => modal avec texte + icônes FB/IG du chapitre référent
 * - Inter-chapitre: on garde la ligne "Chapitre :" + réseaux du chapitre visité (si ID dispo)
 */
function lag_events_render_detail_card(array $ev) : string {
  $is_club_house = ($ev['type'] === 'club_house');

  $title = esc_html($ev['title']);
  $date  = esc_html($ev['date_human']);
  $img   = $ev['affiche_url'] ? esc_url($ev['affiche_url']) : '';

  $lieu = trim((string)$ev['lieu']);
  $maps = trim((string)$ev['maps']);
  $maps_url = $maps ? esc_url($maps) : '';

  $chapitre = trim((string)$ev['chapitre_nom']);
  $desc = (string)$ev['description'];

  $insc = (string)$ev['inscription']; // none/free/paid
  $lien_insc = trim((string)$ev['lien_inscription']);
  $prix = $ev['prix_inscription'];

  $lien_annexe = trim((string)$ev['lien_annexe']);

  // Inscription info (SAUF club house)
  $insc_info = '';
  if (!$is_club_house) {
    if ($insc === 'free') $insc_info = 'Inscription : Gratuit';
    if ($insc === 'paid') {
      $p = ($prix !== null) ? number_format_i18n((float)$prix, 2).' €' : '';
      $insc_info = 'Inscription : Payant'.($p ? ' • '.$p : '');
    }
  }

  // Club house socials: chapitre référent (FB/IG seulement)
  $club_socials = [];
  if ($is_club_house) {
    $ref_id = lag_events_get_referent_chapitre_id();
    if ($ref_id) {
      $all = lag_events_get_chapitre_socials($ref_id);
      // uniquement facebook + instagram
      if (!empty($all['facebook']))  $club_socials['facebook']  = $all['facebook'];
      if (!empty($all['instagram'])) $club_socials['instagram'] = $all['instagram'];
    }
  }

  ob_start(); ?>
  <div class="lag-ev-card">
    <div class="lag-ev-top">
      <h3 class="lag-ev-title lag-viking"><?php echo $title; ?></h3>
      <?php if ($date): ?>
        <div class="lag-ev-date"><?php echo $date; ?></div>
      <?php endif; ?>
    </div>

    <div class="lag-ev-two">
      <?php if ($img): ?>
        <div class="lag-ev-poster">
          <img src="<?php echo $img; ?>" alt="" loading="lazy" />
        </div>
      <?php endif; ?>

      <div class="lag-ev-right">

        <?php if (!$is_club_house && $lieu): ?>
          <div class="lag-ev-meta lag-ev-lieu-row">
            <strong>Lieu :</strong>
            <span class="lag-ev-lieu-text"><?php echo esc_html($lieu); ?></span>
            <?php if ($maps_url): ?>
              <a class="lag-ev-maps-link" href="<?php echo $maps_url; ?>" target="_blank" rel="noopener" aria-label="Ouvrir dans Google Maps">
                <?php echo lag_events_svg_map_pin(); ?>
              </a>
            <?php endif; ?>
          </div>
        <?php endif; ?>

        <?php if ($chapitre): ?>
          <div class="lag-ev-meta lag-ev-chap-row">
            <strong>Chapitre :</strong>
            <span class="lag-ev-chap-name"><?php echo esc_html($chapitre); ?></span>

            <?php
              // Réseaux seulement si chapitre visité + ID chapitre dispo
              if (!empty($ev['chapitre_id'])) {
                $socials = lag_events_get_chapitre_socials((int)$ev['chapitre_id']);
                if (!empty($socials)) {
                  echo '<span class="lag-ev-socials" aria-label="Réseaux du chapitre">';
                  foreach ($socials as $k => $url) {
                    $icon = lag_events_get_icon_url($k);
                    if (!$icon) continue;
                    echo '<a class="lag-ev-social" href="'.esc_url($url).'" target="_blank" rel="noopener" aria-label="'.esc_attr($k).'">';
                    echo '<img src="'.esc_url($icon).'" alt="" loading="lazy" />';
                    echo '</a>';
                  }
                  echo '</span>';
                }
              }
            ?>
          </div>
        <?php endif; ?>

        <?php if (!empty($desc)): ?>
          <div class="lag-ev-desc"><?php echo wp_kses_post($desc); ?></div>
        <?php endif; ?>

        <?php if ($insc_info): ?>
          <div class="lag-ev-meta"><strong><?php echo esc_html($insc_info); ?></strong></div>
        <?php endif; ?>

        <?php if (!empty($lien_annexe)): ?>
          <div class="lag-ev-meta">
            <a class="lag-ev-more" href="<?php echo esc_url($lien_annexe); ?>" target="_blank" rel="noopener">Infos complémentaires</a>
          </div>
        <?php endif; ?>

        <div class="lag-ev-spacer"></div>

        <div class="lag-ev-actions">
          <div></div>
          <div class="lag-ev-rightbtn">
            <?php if ($is_club_house): ?>
              <button type="button" class="lag-ev-btn" data-lag-contact="1">Nous contacter</button>
            <?php else: ?>
              <?php
                if ($insc === 'free' || $insc === 'paid') {
                  if (!empty($lien_insc)) {
                    echo '<a class="lag-ev-btn" href="'.esc_url($lien_insc).'" target="_blank" rel="noopener">S\'inscrire</a>';
                  } else {
                    echo '<button type="button" class="lag-ev-btn" data-lag-soon="1">Inscription prochainement</button>';
                  }
                }
              ?>
            <?php endif; ?>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal (inscription prochainement) -->
    <div class="lag-modal lag-modal-soon" aria-hidden="true">
      <div class="lag-modal-backdrop"></div>
      <div class="lag-modal-card" role="dialog" aria-modal="true">
        <div class="lag-modal-title lag-viking">Inscriptions prochainement</div>
        <div class="lag-modal-body">
          <div class="lag-modal-text">Les inscriptions ne sont pas encore disponibles. Reviens bientôt.</div>
        </div>
        <div class="lag-modal-actions">
          <button type="button" class="lag-ev-btn lag-modal-close">OK</button>
        </div>
      </div>
    </div>

    <!-- Modal (club house - nous contacter) -->
    <div class="lag-modal lag-modal-contact" aria-hidden="true">
      <div class="lag-modal-backdrop"></div>
      <div class="lag-modal-card" role="dialog" aria-modal="true">
        <div class="lag-modal-title lag-viking">Nous contacter</div>
        <div class="lag-modal-text">
          Pour nous rencontrer au club house, il est nécessaire de prendre contact avec nous sur nos réseaux.
        </div>

        <?php if (!empty($club_socials)): ?>
          <div class="lag-contact-socials" aria-label="Réseaux du chapitre référent">
            <?php foreach ($club_socials as $k => $url): ?>
              <?php $icon = lag_events_get_icon_url($k); if(!$icon) continue; ?>
              <a class="lag-ev-social" href="<?php echo esc_url($url); ?>" target="_blank" rel="noopener" aria-label="<?php echo esc_attr($k); ?>">
                <img src="<?php echo esc_url($icon); ?>" alt="" loading="lazy" />
              </a>
            <?php endforeach; ?>
          </div>
        <?php endif; ?>

        <div class="lag-modal-actions">
			<button type="button" class="lag-ev-btn lag-modal-close">OK</button>
		</div>
      </div>
    </div>

  </div>
  <?php
  return ob_get_clean();
}

/* AJAX fetch détail */
add_action('wp_ajax_lag_events_fetch', 'lag_events_ajax_fetch');
add_action('wp_ajax_nopriv_lag_events_fetch', 'lag_events_ajax_fetch');
function lag_events_ajax_fetch() {
  $id = isset($_POST['id']) ? (int) $_POST['id'] : 0;
  if (!$id) wp_send_json_error(['msg' => 'ID manquant']);

  $ev = lag_events_get_event_data($id);
  if (empty($ev['id'])) wp_send_json_error(['msg' => 'Introuvable']);

  wp_send_json_success([
    'html'  => lag_events_render_detail_card($ev),
    'event' => $ev,
  ]);
}

/* AJAX mois calendrier */
add_action('wp_ajax_lag_events_month', 'lag_events_ajax_month');
add_action('wp_ajax_nopriv_lag_events_month', 'lag_events_ajax_month');
function lag_events_ajax_month() {
  $year = isset($_POST['year']) ? (int)$_POST['year'] : (int)date('Y');
  $month = isset($_POST['month']) ? (int)$_POST['month'] : (int)date('n');

  $map = lag_events_get_month_map($year, $month);
  wp_send_json_success([
    'year'         => $year,
    'month'        => $month,
    'events_by_day'=> $map['events_by_day'],
    'best_by_day'  => $map['best_by_day'],
  ]);
}

add_shortcode('lag_events_page', function() {
  $cfg = lag_events_config();
  $ui  = $cfg['ui'];

  $next_id  = lag_events_get_next_event_id();
  $upcoming = lag_events_get_list('upcoming');
  $past     = lag_events_get_list('past');

  $year  = (int)date('Y');
  $month = (int)date('n');
  $month_map = lag_events_get_month_map($year, $month);

  $detail_html = $next_id
    ? lag_events_render_detail_card(lag_events_get_event_data($next_id))
    : '<div class="lag-ev-empty">Aucun évènement.</div>';

  ob_start(); ?>
  <div class="lag-events"
       data-selected="<?php echo (int)$next_id; ?>"
       data-year="<?php echo $year; ?>"
       data-month="<?php echo $month; ?>">

    <div class="lag-top">
      <section class="lag-box lag-box-detail" id="lag-ev-detail"><?php echo $detail_html; ?></section>

      <section class="lag-box lag-box-cal" id="lag-ev-calendar">
        <div class="lag-cal-head">
          <button class="lag-cal-nav" data-dir="-1" type="button" aria-label="Mois précédent">‹</button>
          <div class="lag-cal-title" id="lag-cal-title"></div>
          <button class="lag-cal-nav" data-dir="1" type="button" aria-label="Mois suivant">›</button>
        </div>

        <div class="lag-cal-weekdays">
          <span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span><span>D</span>
        </div>

        <div class="lag-cal-grid" id="lag-cal-grid"></div>

        <!-- POPUP choix évènements du jour -->
        <div class="lag-modal lag-day-modal" aria-hidden="true">
          <div class="lag-modal-backdrop"></div>
          <div class="lag-modal-card" role="dialog" aria-modal="true">
            <div class="lag-modal-title lag-viking">Évènements du jour</div>
            <div class="lag-modal-body">
              <div class="lag-day-modal-items" id="lag-day-modal-items"></div>
            </div>
            <div class="lag-modal-actions">
              <button type="button" class="lag-ev-btn lag-day-modal-close">Fermer</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="lag-bottom">
      <section class="lag-box" id="lag-ev-upcoming">
        <h3 class="lag-box-title lag-viking">À venir</h3>
        <div class="lag-list" id="lag-list-upcoming">
          <?php foreach ($upcoming as $ev): ?>
            <button class="lag-item" type="button"
              data-id="<?php echo (int)$ev['id']; ?>"
              data-day="<?php echo esc_attr($ev['date_iso']); ?>">
              <span class="lag-item-main">
                <span class="lag-item-title"><?php echo esc_html($ev['title']); ?></span>
                <span class="lag-item-sub" data-short="<?php echo esc_attr(date_i18n('d/m', (int)$ev['timestamp'])); ?>">
                  <?php echo esc_html($ev['date_human']); ?>
                </span>
              </span>
            </button>
          <?php endforeach; ?>
        </div>
      </section>

      <section class="lag-box" id="lag-ev-past">
        <h3 class="lag-box-title lag-viking">Passés</h3>
        <div class="lag-list" id="lag-list-past">
          <?php foreach ($past as $ev): ?>
            <button class="lag-item" type="button"
              data-id="<?php echo (int)$ev['id']; ?>"
              data-day="<?php echo esc_attr($ev['date_iso']); ?>">
              <span class="lag-item-main">
                <span class="lag-item-title"><?php echo esc_html($ev['title']); ?></span>
                <span class="lag-item-sub" data-short="<?php echo esc_attr(date_i18n('d/m', (int)$ev['timestamp'])); ?>">
                  <?php echo esc_html($ev['date_human']); ?>
                </span>
              </span>
            </button>
          <?php endforeach; ?>
        </div>
      </section>
    </div>
  </div>

  <style>
    .lag-events{
      --bg: <?php echo $ui['bg']; ?>;
      --panel: <?php echo $ui['panel']; ?>;
      --panel2: <?php echo $ui['panel_2']; ?>;
      --border: <?php echo $ui['border']; ?>;
      --text: <?php echo $ui['text']; ?>;
      --muted: <?php echo $ui['muted']; ?>;
      --muted2: <?php echo $ui['muted2']; ?>;

      --gold: <?php echo $ui['gold']; ?>;
      --goldbg: <?php echo $ui['goldbg']; ?>;
      --goldbg2: <?php echo $ui['goldbg2']; ?>;
      --goldbd: <?php echo $ui['goldbd']; ?>;

      --shadow: <?php echo $ui['shadow']; ?>;
      --sel: <?php echo $ui['sel']; ?>;

      --viking: "<?php echo esc_attr($ui['font_viking']); ?>";
      color: var(--text);
    }

    .lag-top{
      display:grid;
      grid-template-columns: 1.6fr .8fr;
      gap:14px;
      align-items:stretch;
    }
    .lag-bottom{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 900px){
      .lag-top{ grid-template-columns: 1fr; }
      .lag-bottom{ grid-template-columns: 1fr; }
    }

    .lag-box{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 16px 40px var(--shadow);
      overflow:hidden;
      height: 100%;
    }

    #lag-ev-calendar{ display:flex; flex-direction:column; }

    .lag-viking{
      font-family: var(--viking), "Cinzel", serif !important;
      letter-spacing:.7px;
      color: var(--gold) !important;
      text-shadow: 0 1px 0 rgba(0,0,0,.35);
    }

    .lag-box-title{ margin:0 0 10px 0; font-size:18px; }

    /* DETAIL */
    .lag-ev-card{ height:100%; display:flex; flex-direction:column; }
    .lag-ev-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .lag-ev-title{ margin:0; font-size:22px; line-height:1.12; }
    .lag-ev-date{
      color: rgba(255,255,255,.92);
      font-weight:950;
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      white-space:nowrap;
    }

    .lag-ev-two{
      display:grid;
      grid-template-columns: .95fr 1.05fr;
      gap:12px;
      margin-top:12px;
      align-items:stretch;
      flex:1;
      min-height: 0;
    }
    @media (max-width: 900px){ .lag-ev-two{ grid-template-columns: 1fr; } }

    .lag-ev-poster{
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 220px;
    }
    .lag-ev-poster img{
      width:100%;
      height:100%;
      max-height: 380px;
      object-fit: contain;
      display:block;
      filter: contrast(1.02) brightness(.92);
    }

    .lag-ev-right{ display:flex; flex-direction:column; min-height:0; }
    .lag-ev-meta{ margin:6px 0; color: var(--muted); }
    .lag-ev-desc{ margin-top:10px; color: var(--text); opacity:.95; }
    .lag-ev-desc p{ margin: 0 0 8px 0; }

    .lag-ev-chap-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .lag-ev-socials,
    .lag-contact-socials{
      display:inline-flex;
      gap:8px;
      align-items:center;
      margin-left:6px;
      margin-top: 6px;
    }
    .lag-ev-social{
      width:22px; height:22px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      text-decoration:none !important;
    }
    .lag-ev-social img{
      width:14px; height:14px;
      object-fit:contain;
      display:block;
      filter: brightness(.95);
    }
    .lag-ev-social:hover{
      border-color: rgba(154,116,36,.40);
      background: rgba(255,255,255,.05);
    }

    .lag-ev-more{
      color: rgba(255,255,255,.92) !important;
      font-weight:950;
      text-decoration:none !important;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10) !important;
      display:inline-flex;
      width: fit-content;
      gap: 8px;
      align-items:center;
    }
    .lag-ev-more:hover{
      border-color: rgba(154,116,36,.35) !important;
      background: rgba(255,255,255,.05) !important;
    }

    .lag-ev-lieu-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .lag-ev-maps-link{
      width:30px; height:30px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.92) !important;
      text-decoration:none;
    }
    .lag-ev-maps-link:hover{ border-color: rgba(154,116,36,.30); }

    .lag-ev-spacer{ flex:1; }
    .lag-ev-actions{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      margin-top:12px;
    }

    /* BOUTONS OR */
    .lag-ev-btn,
    .lag-item,
    .lag-cal-choice,
    .lag-modal-close,
    .lag-day-modal-close{
      background: var(--goldbg) !important;
      border: 1px solid var(--goldbd) !important;
      color: rgba(255,255,255,.95) !important;
      box-shadow: none !important;
      text-decoration: none !important;
    }
    .lag-ev-btn:hover,
    .lag-item:hover,
    .lag-cal-choice:hover{
      background: var(--goldbg2) !important;
      border-color: rgba(154,116,36,.55) !important;
    }

    .lag-ev-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      border-radius:14px;
      font-weight:950;
      cursor:pointer;
      white-space:nowrap;
    }

    /* LISTS (sans pastille) */
    .lag-list{ display:flex; flex-direction:column; gap:10px; }
    .lag-list.is-scroll{
      max-height: 240px;
      overflow:auto;
      padding-right: 6px;
    }
    .lag-list.is-scroll::-webkit-scrollbar{ width: 8px; }
    .lag-list.is-scroll::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 10px;
    }

    .lag-item{
      display:flex; align-items:center;
      width:100%; text-align:left;
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease;
      -webkit-tap-highlight-color: transparent;
      outline: none !important;
      gap: 0;
    }
    .lag-item:focus-visible{
      outline: 3px solid var(--sel) !important;
      outline-offset: 2px !important;
    }
    .lag-item-main{ min-width:0; width:100%; }
    .lag-item-title{ font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .lag-item-sub{ font-size:12px; color: rgba(255,255,255,.78) !important; }

    /* CALENDAR */
    .lag-cal-head{
      display:grid;
      grid-template-columns: 28px 1fr 28px;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .lag-cal-title{
      text-align:center;
      font-weight:950;
      font-size:18px;
      letter-spacing:.2px;
      color: rgba(255,255,255,.92);
    }
    .lag-cal-nav{
      width:28px; height:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:none !important;
      background: transparent !important;
      color: rgba(255,255,255,.92) !important;
      font-size:26px;
      line-height:1;
      cursor:pointer;
      padding:0;
      box-shadow:none !important;
    }

    .lag-cal-weekdays{
      display:grid; grid-template-columns: repeat(7, 1fr);
      gap:8px; margin-bottom:8px; font-size:12px; color: var(--muted2);
    }
    .lag-cal-weekdays span{ text-align:center; }
    .lag-cal-grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }

    .lag-day{
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      min-height:44px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      position:relative;
      font-weight:950;
      color: rgba(255,255,255,.92);
      user-select:none;
      transition: border-color .12s ease;
    }
    .lag-day:hover{ border-color: rgba(154,116,36,.20); }
    .lag-day.is-empty{ opacity:.25; cursor:default; background: transparent !important; }
    .lag-day.has-events{
      background: var(--goldbg2);
      border-color: rgba(154,116,36,.40);
    }
    .lag-day.is-selected{
      outline: 3px solid var(--sel) !important;
      outline-offset: 2px !important;
    }

    /* Compteur d'évènements */
    .lag-day-count{
      position:absolute;
      right:6px;
      top:6px;
      font-size:11px;
      font-weight:950;
      padding:2px 6px;
      border-radius:999px;
      background: rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
      pointer-events:none;
    }

    /* Modal (commun) */
    .lag-modal{ display:none; }
    .lag-modal.is-open{ display:block; }
    .lag-modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      z-index:9998;
    }
    .lag-modal-card{
      display:flex;
      flex-direction:column;
      position:fixed;
      top:50%; left:50%;
      transform: translate(-50%,-50%);
      width:min(460px, 92vw);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      z-index:9999;
      box-shadow: 0 18px 60px rgba(0,0,0,.75);
    }
    .lag-modal-title{ font-weight:950; margin-bottom:10px; }
    .lag-modal-text{ color: var(--muted); margin-bottom:12px; }


    .lag-modal-body{
      flex: 1;
      min-height: 0;
    }
    .lag-modal-actions{
      display:flex;
      justify-content:flex-end;
      margin-top:12px;
    }
    .lag-day-modal-items{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:12px;
      max-height: 320px;
      overflow:auto;
      padding-right: 6px;
    }
    .lag-day-modal-items::-webkit-scrollbar{ width: 8px; }
    .lag-day-modal-items::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 10px;
    }

    .lag-cal-choice{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      text-align:left;
      font-weight:950;
    }

    /* ===== MOBILE PATCH ===== */
    @media (max-width: 600px){

      /* Listes: afficher seulement JJ/MM */
      .lag-item-sub{
        color: transparent !important;
        position: relative;
      }
      .lag-item-sub::before{
        content: attr(data-short);
        color: rgba(255,255,255,.78) !important;
        position: absolute;
        left: 0;
        top: 0;
      }

      /* Fiche détaillée: date sous le titre */
      .lag-ev-top{
        flex-direction: column;
        align-items: flex-start;
      }
      .lag-ev-date{
        margin-top: 8px;
        align-self: flex-start;
        white-space: normal;
      }

      /* Boutons: jamais de dépassement */
      .lag-ev-actions{ justify-content: stretch; }
      .lag-ev-rightbtn{ width: 100%; }
      .lag-ev-btn{
        width: 100%;
        max-width: 100%;
        white-space: normal;
        line-height: 1.1;
        text-align: center;
        padding: 10px 12px;
      }

      /* Raccourci "Inscription prochainement" */
      .lag-ev-btn[data-lag-soon="1"]{ font-size: 14px; }
      .lag-ev-btn[data-lag-soon="1"]{ color: transparent !important; position: relative; }
      .lag-ev-btn[data-lag-soon="1"]::after{
        content: "Inscription proch.";
        color: rgba(255,255,255,.95);
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 10px;
      }
		
	   .lag-ev-detail{ scroll-margin-top: 90px; }
    }
  </style>

  <script>
  (function(){
    const root = document.querySelector('.lag-events');
    if(!root) return;

    const ajaxUrl = '<?php echo esc_js(admin_url('admin-ajax.php')); ?>';

    let year = parseInt(root.dataset.year, 10);
    let month = parseInt(root.dataset.month, 10);
    let selectedDay = '';
    let selectedEventId = parseInt(root.dataset.selected, 10) || 0;

    let monthData = {
      events_by_day: <?php echo wp_json_encode($month_map['events_by_day']); ?>,
      best_by_day:   <?php echo wp_json_encode($month_map['best_by_day']); ?>,
    };

    const calTitle = document.getElementById('lag-cal-title');
    const calGrid  = document.getElementById('lag-cal-grid');
    const detailBox= document.getElementById('lag-ev-detail');

    const dayModal = document.querySelector('#lag-ev-calendar .lag-day-modal');
    const dayModalItems = document.getElementById('lag-day-modal-items');

    const monthNames = ['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'];
	  
	function isMobile(){
      return window.matchMedia('(max-width: 900px)').matches;
    }

    function scrollToDetail(){
      if(!isMobile()) return;

      // Ajuste l’offset selon ton header sticky
      const OFFSET = 90;

      const y = detailBox.getBoundingClientRect().top + window.pageYOffset - OFFSET;
      window.scrollTo({ top: Math.max(0, y), behavior: 'smooth' });
	}

    function pad(n){ return String(n).padStart(2,'0'); }
    function ymd(y,m,d){ return `${y}-${pad(m)}-${pad(d)}`; }
    function firstWeekMondayIndex(date){
      const dow = date.getDay();
      return (dow + 6) % 7;
    }

    function openModal(modal){
      if(!modal) return;
      modal.classList.add('is-open');
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(modal){
      if(!modal) return;
      modal.classList.remove('is-open');
      modal.setAttribute('aria-hidden','true');
    }

    function bindModals(scope){
      // close on backdrop / close btn
      scope.querySelectorAll('.lag-modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target.classList.contains('lag-modal-backdrop') || e.target.classList.contains('lag-modal-close')) {
            closeModal(modal);
          }
        });
      });

      // soon button
      const soonBtn = scope.querySelector('[data-lag-soon="1"]');
      if(soonBtn){
        const soonModal = scope.querySelector('.lag-modal-soon');
        soonBtn.addEventListener('click', () => openModal(soonModal));
      }

      // contact button
      const contactBtn = scope.querySelector('[data-lag-contact="1"]');
      if(contactBtn){
        const contactModal = scope.querySelector('.lag-modal-contact');
        contactBtn.addEventListener('click', () => openModal(contactModal));
      }
    }

    function selectEvent(id){
      if(!id) return;
      selectedEventId = parseInt(id, 10);

      const fd = new FormData();
      fd.append('action', 'lag_events_fetch');
      fd.append('id', selectedEventId);

      fetch(ajaxUrl, { method:'POST', body: fd })
        .then(r => r.json())
        .then(res => {
          if(res?.success){
            detailBox.innerHTML = res.data.html;
            bindModals(detailBox);

            // ✅ remonte automatiquement sur mobile après mise à jour de la fiche
            requestAnimationFrame(scrollToDetail);
          }
        })
        .catch(()=>{});
    }

    function showDayChoicesPopup(dayIso){
      const list = monthData.events_by_day?.[dayIso] || [];
      if(list.length <= 1) return;

      dayModalItems.innerHTML = '';
      list.forEach(ev => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'lag-cal-choice';

        const txt = document.createElement('span');
        txt.textContent = ev.title;

        btn.appendChild(txt);

        btn.addEventListener('click', () => {
          selectEvent(ev.id);
          closeModal(dayModal);
        });

        dayModalItems.appendChild(btn);
      });

      openModal(dayModal);
    }

    function selectDay(dayIso){
      selectedDay = dayIso;
      renderCalendar();

      const list = monthData.events_by_day?.[dayIso] || [];
      const best = monthData.best_by_day?.[dayIso];

      if(list.length > 1){
        showDayChoicesPopup(dayIso);
        if(best?.id) selectEvent(best.id);
        else if(list[0]?.id) selectEvent(list[0].id);
        return;
      }

      if(best?.id) selectEvent(best.id);
      else if(list[0]?.id) selectEvent(list[0].id);
    }

    function renderCalendar(){
      calTitle.textContent = `${monthNames[month-1]} ${year}`;
      calGrid.innerHTML = '';

      const first = new Date(year, month-1, 1);
      const daysInMonth = new Date(year, month, 0).getDate();
      const offset = firstWeekMondayIndex(first);

      for(let i=0;i<offset;i++){
        const div = document.createElement('div');
        div.className = 'lag-day is-empty';
        calGrid.appendChild(div);
      }

      for(let d=1; d<=daysInMonth; d++){
        const dayIso = ymd(year, month, d);
        const cell = document.createElement('div');

        const list = monthData.events_by_day?.[dayIso] || null;

        cell.className = 'lag-day' + (list ? ' has-events' : '');
        cell.textContent = d;

        if(list && list.length > 1){
          const badge = document.createElement('span');
          badge.className = 'lag-day-count';
          badge.textContent = '+' + (list.length - 1);
          cell.appendChild(badge);
        }

        if(dayIso === selectedDay) cell.classList.add('is-selected');

        if(list && list.length){
          cell.addEventListener('click', () => selectDay(dayIso));
        } else {
          cell.addEventListener('click', () => selectDay(dayIso)); // option: clique jour vide => pas d'action, mais conserve sélection
        }
        calGrid.appendChild(cell);
      }
    }

    function loadMonth(y, m){
      const fd = new FormData();
      fd.append('action', 'lag_events_month');
      fd.append('year', y);
      fd.append('month', m);

      fetch(ajaxUrl, { method:'POST', body: fd })
        .then(r => r.json())
        .then(res => {
          if(!res?.success) return;
          year = res.data.year;
          month = res.data.month;
          monthData = {
            events_by_day: res.data.events_by_day || {},
            best_by_day:   res.data.best_by_day || {},
          };
          selectedDay = '';
          renderCalendar();
        })
        .catch(()=>{});
    }

    // nav mois
    document.querySelectorAll('.lag-cal-nav').forEach(b => {
      b.addEventListener('click', () => {
        const dir = parseInt(b.dataset.dir, 10);
        let newM = month + dir, newY = year;
        if(newM < 1){ newM = 12; newY--; }
        if(newM > 12){ newM = 1; newY++; }
        loadMonth(newY, newM);
      });
    });

    // click listes
    document.querySelectorAll('.lag-item').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const day = btn.dataset.day || '';
        if(day){ selectedDay = day; renderCalendar(); }
        selectEvent(id);
      });
    });

    // bind modal jour
    if(dayModal){
      dayModal.addEventListener('click', (e) => {
        if (e.target.classList.contains('lag-modal-backdrop') || e.target.classList.contains('lag-day-modal-close')) {
          closeModal(dayModal);
        }
      });
      const closeBtn = dayModal.querySelector('.lag-day-modal-close');
      if(closeBtn){
        closeBtn.addEventListener('click', () => closeModal(dayModal));
      }
    }

    // bind modals fiche
    bindModals(detailBox);

    // listes scroll > 5
    function applyScrollIfNeeded(listEl){
      if(!listEl) return;
      const items = listEl.querySelectorAll('.lag-item').length;
      if(items > 5) listEl.classList.add('is-scroll');
    }
    applyScrollIfNeeded(document.getElementById('lag-list-upcoming'));
    applyScrollIfNeeded(document.getElementById('lag-list-past'));

    renderCalendar();
  })();
  </script>
  <?php
  return ob_get_clean();
});
