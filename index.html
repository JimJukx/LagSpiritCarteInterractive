<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Lag Spirit ‚Äì Aide Harc√®lement & Carte des Chapitres</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  ></script>

  <style>
    :root {
      --lag-black: #000000;
      --lag-white: #ffffff;
      --lag-gold: #d4af37;
      --lag-gold-soft: #e7c865;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #111;
      color: var(--lag-white);
    }

    header {
      padding: 0.4rem 0.9rem;
      background: var(--lag-black);
      color: var(--lag-white);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      border-bottom: 2px solid var(--lag-gold);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid var(--lag-gold);
      overflow: hidden;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    header h1 {
      font-size: 1.05rem;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    header .subtitle {
      font-size: 0.82rem;
      opacity: 0.9;
    }

    .search-area {
      margin-left: auto;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-area input {
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      border: 1px solid #444;
      min-width: 180px;
      background: #111;
      color: #f5f5f5;
      font-size: 0.85rem;
    }

    .search-area input::placeholder {
      color: #777;
    }

    .search-area button {
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      border: 1px solid var(--lag-gold);
      background: var(--lag-gold);
      color: var(--lag-black);
      cursor: pointer;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      white-space: nowrap;
    }

    .search-area button:hover {
      background: var(--lag-black);
      color: var(--lag-gold);
    }

    main {
      display: flex;
      flex: 1;
      min-height: 0;
    }

    #map {
      flex: 2;
      height: 100%;
      position: relative;
    }

    .sidebar {
      flex: 1;
      max-width: 380px;
      border-left: 1px solid #333;
      padding: 0.75rem 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      background: #141414;
      color: #f5f5f5;
    }

    .sidebar h2 {
      font-size: 1rem;
      margin: 0;
      color: var(--lag-gold);
    }

    .info-text {
      font-size: 0.85rem;
      color: #d0d0d0;
    }

    .chapter-card {
      margin-top: 0.5rem;
      padding: 0.75rem;
      border-radius: 0.75rem;
      background: #181818;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      border: 1px solid #333;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .chapter-card h3 {
      margin: 0.1rem 0 0.25rem 0;
      font-size: 1rem;
    }

    .chapter-tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--lag-black);
      color: var(--lag-gold);
      border-radius: 999px;
      padding: 0.18rem 0.75rem;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin: 0 auto 0.4rem auto;
      border: 1px solid var(--lag-gold);
    }

    .chapter-card p {
      margin: 0.15rem 0;
      font-size: 0.85rem;
    }

    .chapter-card strong {
      font-weight: 600;
      color: var(--lag-gold-soft);
    }

    .chapter-card a {
      color: var(--lag-gold-soft);
      text-decoration: none;
    }

    .chapter-card a:hover {
      text-decoration: underline;
    }

    .help-highlight {
      margin-top: 0.5rem;
      padding: 0.5rem 0.6rem;
      border-radius: 0.6rem;
      background: rgba(212, 175, 55, 0.1);
      border: 1px solid rgba(212, 175, 55, 0.6);
      font-size: 0.8rem;
    }

    .chapters-list-wrapper {
      margin-top: 0.75rem;
      padding-top: 0.5rem;
      border-top: 1px solid #333;
    }

    .chapters-list-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #cccccc;
      margin-bottom: 0.25rem;
    }

    .chapters-list {
      max-height: 180px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .chapter-list-item {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 0.4rem;
      background: #181818;
      border: 1px solid #333;
      border-radius: 999px;
      padding: 0.25rem 0.55rem;
      font-size: 0.8rem;
      color: #eee;
      cursor: pointer;
    }

    .chapter-list-item:hover {
      border-color: var(--lag-gold-soft);
      background: #202020;
    }

    .chapter-list-main {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      overflow: hidden;
    }

    .chapter-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .chapter-name {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 220px;
    }

    .leaflet-container {
      background: #101010;
    }

    .motto {
      font-size: 1.2rem;
      text-align: center;
      margin-top: 1rem;
      color: var(--lag-gold-soft);
      font-weight: 600;
    }

    .motto-logo {
      margin-top: 0.3rem;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .motto-logo img {
      max-width: 200px;
      width: 50%;
      min-width: 100px;
      height: auto;
      display: block;
      margin: 0.4rem auto 0 auto;
    }

    @media (max-width: 800px) {
      main {
        flex-direction: column;
      }
      .sidebar {
        max-width: none;
        border-left: none;
        border-top: 1px solid #333;
        height: 45vh;
      }
      #map {
        height: 55vh;
      }
      header {
        gap: 0.4rem;
      }
      .search-area {
        width: 100%;
        margin-left: 0;
        justify-content: flex-start;
      }
    }
  </style>
</head>

<body>

<header>
  <div class="brand">
    <div class="brand-logo">
      <img src="lagspirit-logo.png" alt="Logo Lag Spirit" />
    </div>
    <div>
      <h1>Lag Spirit ‚Äì Carte des Chapitres</h1>
      <div class="subtitle">Soutiens aux victimes de harc√®lement scolaire</div>
    </div>
  </div>

  <div class="search-area">
    <input
      id="city-search"
      type="text"
      placeholder="Tape ta ville (ex : Lyon, Brest...)"
    />
    <button id="search-btn">Trouve le chapitre le plus proche</button>
  </div>
</header>

<main>
  <div id="map"></div>

  <aside class="sidebar">
    <h2>Besoin d‚Äôaide&nbsp;?</h2>
    <p class="info-text">
      Entre ta ville ou clique sur une zone de la carte.
      Le chapitre le plus proche (dans la limite de 100 km) appara√Ætra ici
      avec ses contacts.
    </p>

    <div id="result-card" class="chapter-card">
      <div class="chapter-tag">Chapitre s√©lectionn√©</div>
      <h3>Aucun chapitre affich√©</h3>
      <p>
        Entre une ville ou clique sur une zone de la carte pour afficher
        le chapitre le plus proche (si un chapitre existe √† moins de 100 km).
      </p>
    </div>

    <div class="chapters-list-wrapper">
      <div class="chapters-list-title">Chapitres Lag Spirit</div>
      <div id="chapters-list" class="chapters-list"></div>
    </div>

    <p class="motto">ü§ú FORT ENSEMBLE ü§õ</p>
    <div class="motto-logo">
      <img src="lagspirit-logo.png" alt="Logo Lag Spirit" />
    </div>
  </aside>
</main>

<script>
  const DEPARTMENTS_GEOJSON_URL =
    "https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements-version-simplifiee.geojson";

  // Limite de couverture : rayon max en km
  const MAX_DISTANCE_KM = 150;

  let CHAPTERS = [];

  const COLORS = [
    "#e6194b","#3cb44b","#ffe119","#4363d8","#f58231",
    "#911eb4","#46f0f0","#f032e6","#bcf60c","#fabebe",
    "#008080","#e6beff","#9a6324","#fffac8","#800000",
    "#aaffc3","#808000","#ffd8b1","#000075","#808080",
    "#ffffff","#000000","#ff7f50","#6495ed","#ff69b4",
    "#cd5c5c","#ffa500","#40e0d0","#6a5acd","#7fffd4",
    "#deb887","#5f9ea0","#d2691e","#ffb6c1","#20b2aa",
    "#87cefa","#778899","#b0c4de","#00fa9a","#9370db",
    "#3cb371","#7b68ee","#48d1cc","#c71585","#191970",
    "#f4a460","#2e8b57","#fff0f5","#708090","#9acd32"
  ];

  const map = L.map("map").setView([46.8, 2.5], 6);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "¬© OpenStreetMap contributors"
  }).addTo(map);

  let chapterMarkers = [];
  let departmentLayers = [];
  let selectedChapterIndex = null;

  function geocodeCity(city) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city + ", France")}`;
    return fetch(url, { headers: { "Accept-Language": "fr" } })
      .then(res => res.json())
      .then(results => {
        if (results && results.length > 0) {
          return {
            lat: parseFloat(results[0].lat),
            lon: parseFloat(results[0].lon)
          };
        }
        return null;
      })
      .catch(() => null);
  }

  function haversineDistance(lat1, lon1, lat2, lon2) {
    function toRad(v) { return v * Math.PI / 180; }
    const R = 6371;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  async function initChapters() {
    let i = 0;
    for (const chapter of CHAPTERS) {
      const coords = await geocodeCity(chapter.city);
      if (coords) {
        chapter.lat = coords.lat;
        chapter.lon = coords.lon;

        const color = COLORS[i % COLORS.length];

        const marker = L.circleMarker([chapter.lat, chapter.lon], {
          radius: 7,
          color: "#000000",
          weight: 2,
          fillColor: color,
          fillOpacity: 1
        }).addTo(map);

        marker.bindPopup(`<b>${chapter.name}</b><br>${chapter.city}`);

        chapterMarkers.push(marker);
        i++;
      } else {
        console.warn("Impossible de g√©ocoder la ville:", chapter.city);
      }
      await new Promise(r => setTimeout(r, 300));
    }
  }

  function refreshDepartmentStyles() {
    departmentLayers.forEach(({ layer, chapterIndex, color, distance }) => {
      if (chapterIndex === -1 || distance > MAX_DISTANCE_KM) {
        // d√©partements non couverts
        layer.setStyle({
          color: "#555555",
          weight: 1,
          fillColor: "#202020",
          fillOpacity: 0.15
        });
        return;
      }

      if (selectedChapterIndex === null) {
        layer.setStyle({
          color: color,
          weight: 1.5,
          fillColor: color,
          fillOpacity: 0.25
        });
      } else if (chapterIndex === selectedChapterIndex) {
        layer.setStyle({
          color: color,
          weight: 3,
          fillColor: color,
          fillOpacity: 0.45
        });
      } else {
        layer.setStyle({
          color: color,
          weight: 1,
          fillColor: color,
          fillOpacity: 0.12
        });
      }
    });
  }

  async function loadDepartments() {
    const res = await fetch(DEPARTMENTS_GEOJSON_URL);
    const geojson = await res.json();

    departmentLayers = [];

    L.geoJSON(geojson, {
      style: function () {
        return {
          color: "#d4af37",
          weight: 1.5,
          fillColor: "#ffffff",
          fillOpacity: 0.25
        };
      },
      onEachFeature: function (feature, layer) {
        const center = layer.getBounds().getCenter();

        let bestChapter = null;
        let bestDistance = Infinity;
        let bestIndex = -1;

        CHAPTERS.forEach((ch, idx) => {
          if (typeof ch.lat !== "number" || typeof ch.lon !== "number") return;
          const d = haversineDistance(center.lat, center.lng, ch.lat, ch.lon);
          if (d < bestDistance) {
            bestDistance = d;
            bestChapter = ch;
            bestIndex = idx;
          }
        });

        const deptName =
          feature.properties &&
          (feature.properties.nom || feature.properties.NOM || "D√©partement");

        if (bestChapter && bestIndex >= 0 && bestDistance <= MAX_DISTANCE_KM) {
          const color = COLORS[bestIndex % COLORS.length];

          departmentLayers.push({ layer, chapterIndex: bestIndex, color, distance: bestDistance });

          let popupContent =
            `<b>${deptName}</b><br>` +
            `Chapitre : ${bestChapter.name}<br>` +
            `Ville du chapitre : ${bestChapter.city}<br>` +
            `<small>Vous pouvez prendre contact avec ce chapitre afin d‚Äôobtenir des informations ou des conseils.</small>`;

          layer.bindPopup(popupContent);

          layer.on("click", function () {
            selectedChapterIndex = bestIndex;
            refreshDepartmentStyles();
            updateResultCard(bestChapter, deptName, false, bestDistance);
          });
        } else {
          const color = "#555555";
          departmentLayers.push({ layer, chapterIndex: -1, color, distance: Infinity });

          layer.setStyle({
            color: color,
            weight: 1,
            fillColor: "#202020",
            fillOpacity: 0.15
          });

          layer.bindPopup(
            `<b>${deptName}</b><br>` +
            `Aucun chapitre Lag Spirit √† proximit√©.<br>` +
            `<small>Vous pouvez utiliser la recherche en haut de la page pour conna√Ætre le chapitre Lag Spirit le plus proche ou utiliser les num√©ros d‚Äôurgence si n√©cessaire.</small>`
          );
        }
      }
    }).addTo(map);

    refreshDepartmentStyles();
  }

  function updateResultCard(chapter, searchedCity, notFound, distanceKm) {
    const card = document.getElementById("result-card");

    if (!chapter || notFound) {
      card.innerHTML = `
        <div class="chapter-tag">Chapitre s√©lectionn√©</div>
        <h3>Aucun chapitre √† proximit√©</h3>
        <p>
          Aucun chapitre Lag Spirit n‚Äôa √©t√© identifi√© √† proximit√© de
          <strong>${searchedCity}</strong>.
        </p>
        <p>
          Vous pouvez utiliser la recherche en haut de la page pour conna√Ætre
          le chapitre Lag Spirit le plus proche et obtenir des informations
          ou des conseils.
        </p>
        <div class="help-highlight">
          <strong>Num√©ros d‚Äôurgence :</strong><br>
          17 ‚Äì Police / Gendarmerie<br>
          15 ‚Äì SAMU (urgence m√©dicale)<br>
          3020 ‚Äì Harc√®lement scolaire<br>
          3018 ‚Äì Cyberharc√®lement et violences num√©riques<br>
          119 ‚Äì Enfance en danger
        </div>
      `;
      return;
    }

    const phone = chapter.contactPhone
      ? `<p><strong>T√©l√©phone :</strong> ${chapter.contactPhone}</p>`
      : "";

    const emailLink = chapter.contactEmail
      ? `<p><strong>Email :</strong> <a href="mailto:${chapter.contactEmail}" target="_blank">${chapter.contactEmail}</a></p>`
      : "";

    const facebookLink = chapter.facebook
      ? `<p><strong>Facebook :</strong> <a href="${chapter.facebook}" target="_blank">Ouvrir la page</a></p>`
      : "";

    const instagramLink = chapter.instagram
      ? `<p><strong>Instagram :</strong> <a href="${chapter.instagram}" target="_blank">Ouvrir le profil</a></p>`
      : "";

    const dist = distanceKm
      ? `<p><strong>Distance estim√©e :</strong> ~${distanceKm.toFixed(0)} km</p>`
      : "";

    const helpInfo = chapter.helpInfo
      ? `<div class="help-highlight">${chapter.helpInfo}</div>`
      : "";

    card.innerHTML = `
      <div class="chapter-tag">Chapitre s√©lectionn√©</div>
      <h3>${chapter.name}</h3>

      <p><strong>Ville du chapitre :</strong> ${chapter.city}</p>
      <p><strong>Ville / zone recherch√©e :</strong> ${searchedCity}</p>
      ${dist}

      ${phone}
      ${emailLink}
      ${facebookLink}
      ${instagramLink}

      ${helpInfo}
    `;
  }

  function renderChaptersList() {
    const container = document.getElementById("chapters-list");
    if (!container) return;
    container.innerHTML = "";

    CHAPTERS.forEach((ch, idx) => {
      const color = COLORS[idx % COLORS.length];
      const btn = document.createElement("button");
      btn.className = "chapter-list-item";
      btn.dataset.idx = idx;

      btn.innerHTML = `
        <div class="chapter-list-main">
          <span class="chapter-dot" style="background:${color}"></span>
          <span class="chapter-name">${ch.name}</span>
        </div>
      `;

      btn.addEventListener("click", () => {
        selectedChapterIndex = idx;
        refreshDepartmentStyles();

        if (typeof ch.lat === "number" && typeof ch.lon === "number") {
          map.setView([ch.lat, ch.lon], 7);
        }
        updateResultCard(ch, ch.city, false, null);
      });

      container.appendChild(btn);
    });
  }

  async function searchCity() {
    const input = document.getElementById("city-search");
    const query = input.value.trim();
    if (!query) return;

    const coords = await geocodeCity(query);
    if (!coords) {
      updateResultCard(null, query, true);
      return;
    }

    let bestChapter = null;
    let bestDistance = Infinity;
    let bestIndex = -1;

    CHAPTERS.forEach((chapter, idx) => {
      if (typeof chapter.lat !== "number" || typeof chapter.lon !== "number") return;
      const d = haversineDistance(coords.lat, coords.lon, chapter.lat, chapter.lon);
      if (d < bestDistance) {
        bestDistance = d;
        bestChapter = chapter;
        bestIndex = idx;
      }
    });

    map.setView([coords.lat, coords.lon], 7);

    if (bestChapter && bestDistance <= MAX_DISTANCE_KM) {
      selectedChapterIndex = bestIndex;
      refreshDepartmentStyles();
      updateResultCard(bestChapter, query, false, bestDistance);
    } else {
      updateResultCard(null, query, true);
    }
  }

  document.getElementById("search-btn").addEventListener("click", searchCity);
  document.getElementById("city-search").addEventListener("keyup", (e) => {
    if (e.key === "Enter") searchCity();
  });

  async function loadChapters() {
    try {
      const res = await fetch("chapters.json");
      CHAPTERS = await res.json();

      await initChapters();
      renderChaptersList();
      await loadDepartments();
    } catch (e) {
      console.error("Erreur de chargement de chapters.json", e);
      alert("Impossible de charger la liste des chapitres (chapters.json).");
    }
  }

  loadChapters();
</script>

</body>
</html>
